{% extends "base.html" %}

{% block title %}Accounts - Kessel Run{% endblock %}

{% block page_title %}Monitored Accounts{% endblock %}

{% block header_actions %}
<button class="btn btn-primary" onclick="showAddAccountModal()">
    + Add Account
</button>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3>Instagram Accounts</h3>
        <span class="badge" id="account-count">0 accounts</span>
    </div>
    
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Stories</th>
                    <th>Added</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="accounts-table-body">
                <tr class="loading-row">
                    <td colspan="4">Loading accounts...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Add Account Modal -->
<div class="modal-overlay" id="add-account-modal">
    <div class="modal">
        <div class="modal-header">
            <h3>Add Account</h3>
            <button class="modal-close" onclick="hideAddAccountModal()">&times;</button>
        </div>
        <form id="add-account-form" onsubmit="addAccount(event)">
            <div class="modal-body">
                <div class="form-group">
                    <label for="username">Instagram Username</label>
                    <input 
                        type="text" 
                        id="username" 
                        name="username" 
                        placeholder="e.g. @example_account"
                        required
                    >
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="include_stories" name="include_stories">
                        <span>Include Stories</span>
                    </label>
                    <small class="form-hint">Stories require login cookies and take longer to scrape</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideAddAccountModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Account</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let accounts = [];
    
    // Load accounts on page load
    document.addEventListener('DOMContentLoaded', loadAccounts);
    
    async function loadAccounts() {
        try {
            const result = await apiCall('/api/accounts');
            accounts = result.accounts;
            renderAccounts();
        } catch (error) {
            showToast(error.message, 'error');
        }
    }
    
    function renderAccounts() {
        const tbody = document.getElementById('accounts-table-body');
        const countBadge = document.getElementById('account-count');
        
        countBadge.textContent = `${accounts.length} account${accounts.length !== 1 ? 's' : ''}`;
        
        if (accounts.length === 0) {
            tbody.innerHTML = `
                <tr class="empty-row">
                    <td colspan="4">
                        <div class="empty-state">
                            <span class="empty-icon">ðŸ‘¥</span>
                            <p>No accounts being monitored</p>
                            <button class="btn btn-primary btn-sm" onclick="showAddAccountModal()">
                                Add First Account
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = accounts.map(acc => `
            <tr>
                <td>
                    <a href="https://instagram.com/${acc.username}" target="_blank" class="username-link">
                        @${acc.username}
                    </a>
                </td>
                <td>
                    <label class="toggle-switch">
                        <input 
                            type="checkbox" 
                            ${acc.include_stories ? 'checked' : ''} 
                            onchange="toggleStories('${acc.username}', this.checked)"
                        >
                        <span class="toggle-slider"></span>
                    </label>
                </td>
                <td class="date-cell">${formatDate(acc.added_date)}</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="deleteAccount('${acc.username}')">
                        Remove
                    </button>
                </td>
            </tr>
        `).join('');
    }
    
    function formatDate(isoDate) {
        if (!isoDate) return 'Unknown';
        const date = new Date(isoDate);
        return date.toLocaleDateString('en-GB', { 
            day: 'numeric', 
            month: 'short', 
            year: 'numeric' 
        });
    }
    
    function showAddAccountModal() {
        document.getElementById('add-account-modal').classList.add('show');
        document.getElementById('username').focus();
    }
    
    function hideAddAccountModal() {
        document.getElementById('add-account-modal').classList.remove('show');
        document.getElementById('add-account-form').reset();
    }
    
    async function addAccount(event) {
        event.preventDefault();
        
        const username = document.getElementById('username').value.trim();
        const includeStories = document.getElementById('include_stories').checked;
        
        try {
            await apiCall('/api/accounts', 'POST', {
                username: username,
                include_stories: includeStories
            });
            
            showToast(`Added @${username}`, 'success');
            hideAddAccountModal();
            loadAccounts();
        } catch (error) {
            showToast(error.message, 'error');
        }
    }
    
    async function toggleStories(username, enabled) {
        try {
            await apiCall(`/api/accounts/${username}`, 'PUT', {
                include_stories: enabled
            });
            showToast(`Stories ${enabled ? 'enabled' : 'disabled'} for @${username}`, 'success');
        } catch (error) {
            showToast(error.message, 'error');
            loadAccounts(); // Reload to reset toggle state
        }
    }
    
    async function deleteAccount(username) {
        if (!confirm(`Remove @${username} from monitoring?`)) return;
        
        try {
            await apiCall(`/api/accounts/${username}`, 'DELETE');
            showToast(`Removed @${username}`, 'success');
            loadAccounts();
        } catch (error) {
            showToast(error.message, 'error');
        }
    }
    
    // Close modal on escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') hideAddAccountModal();
    });
</script>
{% endblock %}

